---
- name: A5 - Bring up MySQL for NYC311 and create schema
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    net_name: nyc311_net
    mysql_name: mysql_nyc311
    mysql_image: mysql:8.0
    root_password: rootpw
    db_name: nyc311_db
    app_user: app_user
    app_password: app_password

  tasks:
    - name: Ensure Docker network exists
      community.docker.docker_network:
        name: "{{ net_name }}"
        state: present

    - name: Start MySQL container (local_infile=1, utf8mb4)
      community.docker.docker_container:
        name: "{{ mysql_name }}"
        image: "{{ mysql_image }}"
        state: started
        recreate: false
        restart_policy: unless-stopped
        networks:
          - name: "{{ net_name }}"
        env:
          MYSQL_ROOT_PASSWORD: "{{ root_password }}"
          MYSQL_DATABASE: "{{ db_name }}"
        command:
          - --local-infile=1
          - --character-set-server=utf8mb4
          - --collation-server=utf8mb4_unicode_ci
        volumes:
          # Make data CSVs available at /import
          - "{{ lookup('env', 'HOST_REPO') | default('/work', true) }}/data:/import:ro"
        published_ports:
          - "3306:3306"

    - name: Wait for MySQL to accept root connections
      community.docker.docker_container_exec:
        container: "{{ mysql_name }}"
        command: bash -lc "mysqladmin ping -h 127.0.0.1 -p{{ root_password }} --silent"
      register: ping
      retries: 60
      delay: 2
      until: ping.rc == 0

    - name: Create app user and grant privileges
      community.docker.docker_container_exec:
        container: "{{ mysql_name }}"
        command: >
          bash -lc "mysql -uroot -p{{ root_password }} -e
          \"
          CREATE USER IF NOT EXISTS '{{ app_user }}'@'%' IDENTIFIED BY '{{ app_password }}';
          GRANT ALL PRIVILEGES ON {{ db_name }}.* TO '{{ app_user }}'@'%';
          FLUSH PRIVILEGES;
          \""
      # Ensure a writable /import inside MySQL (we will copy CSV here)
    - name: Ensure /import directory exists in mysql container
      community.docker.docker_container_exec:
        container: "{{ mysql_name }}"
        command: bash -lc "mkdir -p /import && chown -R 999:999 /import || true"

    - name: Resolve absolute CSV path inside controller
      ansible.builtin.set_fact:
        csv_src: "{{ (lookup('env','HOST_REPO') | default('/work', true)) ~ '/data/nyc311_q1_2024.csv' }}"

    - name: Copy CSV from controller into MySQL container
      community.docker.docker_container_copy_into:
        container: "{{ mysql_name }}"
        path: "{{ csv_src }}"
        dest: "/import/nyc311_q1_2024.csv"
        mode: '0644'

    - name: Load CSV with LOAD DATA INFILE (server-side path)
      community.docker.docker_container_exec:
        container: "{{ mysql_name }}"
        command: >
          bash -lc "mysql -u{{ app_user }} -p{{ app_password }} {{ db_name }} -e
          \"
          LOAD DATA INFILE '/import/nyc311_q1_2024.csv'
          INTO TABLE nyc311
          FIELDS TERMINATED BY ',' ENCLOSED BY '\"'
          LINES TERMINATED BY '\n'
          IGNORE 1 LINES
          (@created_date,@closed_date,complaint_type,descriptor,borough,incident_zip,status,resolution_description,latitude,longitude)
          SET
            created_date = NULLIF(STR_TO_DATE(@created_date, '%Y-%m-%dT%H:%i:%s.%f'), ''),
            closed_date  = NULLIF(STR_TO_DATE(@closed_date,  '%Y-%m-%dT%H:%i:%s.%f'), '');
          \""


        # --- Resolve + verify + read schema.sql, then apply via stdin ---
    - name: Resolve absolute schema path inside controller
      ansible.builtin.set_fact:
        schema_path: "{{ lookup('env','HOST_REPO') | default('/work', true) }}/sql/schema.sql"

    - name: Check schema file exists in controller
      ansible.builtin.stat:
        path: "{{ schema_path }}"
      register: schema_stat

    - name: Fail early if schema is missing
      ansible.builtin.fail:
        msg: "Schema not found at {{ schema_path }} inside controller"
      when: not schema_stat.stat.exists

    - name: Read schema file (slurp)
      ansible.builtin.slurp:
        src: "{{ schema_path }}"
      register: schema_b64

    - name: Apply schema via container exec stdin (no docker CLI)
      community.docker.docker_container_exec:
        container: "{{ mysql_name }}"
        command: bash -lc "mysql -u{{ app_user }} -p{{ app_password }} {{ db_name }}"
        stdin: "{{ schema_b64.content | b64decode }}"


